<!DOCTYPE html>
<html>
	<head>
		<title>
			KoalaJS - Cars
		</title>
        <script type="text/javascript" src="../../koala.js"></script>
	</head>
	<body>
		<canvas width=800 height=800 id="gamescreen" style="display:block;margin:auto;"></canvas>
		<script>
		    var ctx = document.getElementById("gamescreen").getContext('2d');
		    var size = 800;
		    var width = size;
		    var height = size;
		    var k = makeKoalaJS();
		    var gridsize = 40;
		    setInterval(draw, 33);

		    function Car(e) {
		        this.target = {
		            x: 0,
                    y:0
		        }
		        k.merge(this, e);
		        k(this);
		    }
		    Car.prototype = {
		        car: true,
		        x: 0,
		        y: 0,
		        speed: 10,
                maxspeed: 10,
		        dirx: 0,
                diry: 0,
		        draw: function () {
		            ctx.fillStyle = "rgb(255,0,0)";
		            ctx.fillRect(this.x - 4.5 + 4.5*this.diry, this.y - 4.5 + 4.5*this.dirx, 9, 9);
		            ctx.strokeStyle = "#000";
		            ctx.strokeRect(this.x - 4.5 + 4.5 * this.diry, this.y - 4.5 + 4.5 * this.dirx, 9, 9);
		        },
		        step: function () {
		            var x = this.x;
		            var y = this.y;
		            var target = this.target;
		            if (target.x == x && target.y == y) {
		                target.x = Math.round(Math.random() * gridsize) * size / gridsize;
		                target.y = Math.round(Math.random() * gridsize) * size / gridsize;
		            }
		            var a = target.x - x;
		            var b = target.y - y;
		            var speed = speedFunction(size);
		            var me = this;
		            function speedFunction(s) {
		                s = Math.abs(s);
		                return Math.sqrt(s)/10;
		            }
		            getSpeed = function (b) {
		                var yes = false;
		                if (me.dirx > 0) {
		                    if (b.x - me.x > 0) {
		                        yes = true;
		                        speed = Math.min(speed, speedFunction(b.x-me.x));
		                    }
		                }
		                if (me.dirx < 0) {
		                    if (b.x - me.x < 0) {
		                        yes = true;
		                        speed = Math.min(speed, speedFunction(b.x - me.x));
		                    }
		                }
		                if (me.diry > 0) {
		                    if (b.y - me.y > 0) {
		                        yes = true;
		                        speed = Math.min(speed, speedFunction(b.y - me.y));
		                    }
		                }
		                if (me.diry < 0) {
		                    if (b.y - me.y < 0) {
		                        yes = true;
		                        speed = Math.min(speed, speedFunction(b.y - me.y));
		                    }
		                }
		                /*if (yes) {
		                    speed = Math.min(b.speed, speed);
		                }*/
                    }
		            if (y % (size / gridsize) == 0 && (x % (size / gridsize) != 0 || Math.abs(a) > Math.abs(b))) {
		                if (a > 0) {
		                    this.dirx = 1;
		                    this.diry = 0;
		                    k('.car.dirx=1.y=' + y, getSpeed);
		                    this.x += Math.min(speed, Math.abs(a));
		                }
		                else {
		                    this.dirx = -1;
		                    this.diry = 0;
		                    k('.car.dirx=-1.y=' + y, getSpeed);
		                    this.x -= Math.min(speed, Math.abs(a));
		                }
		            }
		            else {
		                if (b > 0) {
		                    this.diry = 1;
		                    this.dirx = 0;
		                    k('.car.diry=1.x=' + x, getSpeed);
		                    this.y += Math.min(speed, Math.abs(b));
		                }
		                else {
		                    this.diry = -1;
		                    this.dirx = 0;
		                    k('.car.diry=-1.x=' + x, getSpeed);
		                    this.y -= Math.min(speed, Math.abs(b));
		                }

		            }
		            this.speed = speed;
		        }
		    };
		    makeCars(100);
		    function makeCars(s) {
		        for (var i = 0; i < s; i++) {
		            makeCar();
		        }
		    }
		    function makeCar() {
		        new Car({
		            x: Math.round(Math.random() * gridsize) * size / gridsize,
		            y: Math.round(Math.random() * gridsize) * size / gridsize,
		            target: {
		                x: Math.round(Math.random() * gridsize) * size / gridsize,
		                y: Math.round(Math.random() * gridsize) * size / gridsize,
		            },
		            maxspeed: 5 * Math.random() + 1
		        });
		    }
		    function draw() {
		        ctx.clearRect(0, 0, width, height);

		        ctx.strokeStyle = "#000";
		        for (var x = 0; x < gridsize; x ++) {
		            for (var y = 0; y < gridsize; y++) {
		                ctx.strokeRect(x * size / gridsize, y * size / gridsize, size/gridsize, size/gridsize);
		            }
		        }

		        k('>step');
		        k('>draw');

		        ctx.strokeStyle = "#000";
		        ctx.strokeRect(0, 0, width, height);
		    }
		</script>
	</body>
</html>